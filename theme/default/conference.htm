{-include file="header.htm"-}
<link rel="stylesheet" type="text/css" href="{-$css_path-}common.css"/>
<link rel="stylesheet" href="{-$css_path-}layout.css" type="text/css">
<script src="{-$js_path-}ckeditor/ckeditor.js"></script>
<div class="grid_10 home_box" id="content_box">
	<div class="box">
		<h2>会议签到及会议记录</h2>
			<div class="block" >
				<table>
					<tr>
						<th colspan="12">{-$information.meetingname-}</th>
					</tr>
					<tr>
						<td colspan="4"><b>地点：</b>{-$information.meetingaddress-}</td>
						<td colspan="4"><b>时间：</b>{-$meetTime-}({-$startTime-}—{-$endTime-})</td>
						<td colspan="4"><b>发起者：</b>{-$information.bookuser-}</td>
					</tr>
					<tr>
						<th colspan="6" style="width:50%;">人员统计</th>
						<td colspan="6" style="width:50%;"><b>应到：</b>{-$personNum-}　　　<b>实到：</b>{-$ontimeNumber-}　　　<b>请假：</b>{-$leave-}　　　<b>迟到：</b>{-$lateNumber-}　　　<b>缺席：{-$absent-}</b></td>
					</tr>
					<tr>
						<th colspan="6">人员签到(默认迟到，请在会议开始之前在准时选项框内签到!!)</th>
						<td colspan="6">离会议开始还有：<span id="timeDifference_1"></span></td>
					</tr>
					<tr>
						<th>姓名</th>
						<th>状态</th>
						<th>准时</th>
						<th>迟到</th>
						<th>缺席</th>
						<th>工牌</th>
						<th>姓名</th>
						<th>状态</th>
						<th>准时</th>
						<th>迟到</th>
						<th>缺席</th>
						<th>工牌</th>
					</tr>
					<form id="allpersoninfor" name="personinfor" method="POST" action="">
					{-foreach from=$personRight item=val key=k-}
						<tr style="">
							<td style="color:{-$val.color-};">{-$val.username-}</td>
							<td style="color:{-$val.color-};">{-$val.state-}</td>
							<td>
								<input name="ontimeState" type="checkbox" {-if $val.isagreeattend eq 0-}disabled = "true"{-/if-} id="ontime_{-$val.userid-}" onclick="signIn('ontime_{-$val.userid-}',{-$val.userid-},'ontime')"/>
							</td>
							<td>
								<input name="{-$val.statename-}" type="checkbox" {-if $val.isagreeattend eq 0-}disabled = "true"{-/if-} id="late_{-$val.userid-}" onclick="signIn('late_{-$val.userid-}',{-$val.userid-},'late')"/>
							</td>
							<td>
								<input name="{-$val.statename-}" type="checkbox" {-if $val.isattend eq 0-}checked = 'true'{-/if-} {-if $val.isagreeattend eq 0-}disabled = "true"{-/if-} id="a{-$val.userid-}" onclick = "attend('a{-$val.userid-}')"/>
							</td>
							<td>
								<input name="meetCard" type="checkbox" id="c{-$val.userid-}" {-if $val.wearcard eq 1-}checked = 'true'{-/if-} {-if $val.isagreeattend eq 0-}disabled = "true"{-/if-} onclick = "iscard('c{-$val.userid-}')"/>
							</td>
							<td style="color:{-$personLeft.$k.color-};">{-$personLeft.$k.username-}</td>
							<td style="color:{-$personLeft.$k.color-};">{-$personLeft.$k.state-}</td>
							<td>
								<input name="ontimeState" type="checkbox" {-if $personLeft.$k.isagreeattend eq 0 || $personLeft.$k.isagreeattend eq null-}disabled = "true"{-/if-} id="ontime_{-$personLeft.$k.userid-}" onclick="signIn('ontime_{-$personLeft.$k.userid-}',{-$personLeft.$k.userid-},'ontime')"/>
							</td>
							<td>
								<input name="{-$personLeft.$k.statename-}" type="checkbox" {-if $personLeft.$k.isagreeattend eq 0 || $personLeft.$k.isagreeattend eq null-}disabled = "true"{-/if-} id="late_{-$personLeft.$k.userid-}" onclick="signIn('late_{-$personLeft.$k.userid-}',{-$personLeft.$k.userid-},'late')"/>
							</td>
							<td>
								<input name="{-$personLeft.$k.statename-}" type="checkbox" {-if $personLeft.$k.isattend eq 0-}checked = 'true'{-/if-} {-if $personLeft.$k.isagreeattend eq 0 || $personLeft.$k.isagreeattend eq null-}disabled = "true"{-/if-} id="a{-$personLeft.$k.userid-}" onclick = "attend('a{-$personLeft.$k.userid-}')"/>
							</td>
							<td>
								<input name="meetCard" type="checkbox" id="c{-$personLeft.$k.userid-}" {-if $personLeft.$k.wearcard eq 1-}checked = 'true'{-/if-} {-if $personLeft.$k.isagreeattend eq 0 || $personLeft.$k.isagreeattend eq null-}disabled = "true"{-/if-} onclick = "iscard('c{-$personLeft.$k.userid-}')"/>
							</td>
						</tr>
					{-/foreach-}
						<input type="hidden" name="signInformation" id="signInformations" value=""/>
						<input type="hidden" name="signCard" id="signCard_1" value=""/>
						<input type="hidden" name="signAttend" id="signAttend_1" value=""/>
						<tr>
							<td colspan="12">
								<input name="allontime_1" type="button" value="全选准时" id="allontime" onclick="allSelected()"/>
								<input name="submitInformation_1" type="button" value="提交签到" id="submitInformation"/>
							</td>
						</tr>
					</form>
						<tr><td colspan="12"></td></tr>
						<tr>
							<th colspan="12">会议记录</th>
						</tr>
						<tr>
							<td colspan="12">
								<form name="ckmeet"  method="post" action="" id="meetCkeditor">
									<textarea class="ckeditor" name="meetRecord_1" id="meetRecord">{-$information.meetingsummary-}</textarea>
									<input id="subMeetRecord" name="subMeetRecordButton" type="button" value="提交会议记录" onclick="sub()"/>
								</form>
							</td>
						</tr>
				</table>
			</div>			
	</div>
	<script type="text/javascript">
		function signIn(classid,id,state){
			if(state == 'ontime'){//1代表准时，0代表迟到
				var lateState = document.getElementById('late_'+id);
				var onTimeState = document.getElementById('ontime_'+id);
				var submitInformations = document.getElementById('signInformations').value;
				var re =new RegExp("/"+id + "_1","g");
				var re_1 =new RegExp("/"+id + "_0","g");
				if(lateState.checked == true){
					if(re_1.test(submitInformations)){
						submitInformations_1 = submitInformations.replace(re_1,"");
						document.getElementById('signInformations').value = submitInformations_1;
					}
				}
				if(re.test(submitInformations) && onTimeState.checked == false){
					submitInformations_1 = submitInformations.replace(re,"");
					document.getElementById('signInformations').value = submitInformations_1;
				}else{
					document.getElementById('signInformations').value += '/'+id+'_1';
				}
				lateState.checked = false;
			}
			if(state == 'late'){
				var lateState = document.getElementById('late_'+id);
				var onTimeState = document.getElementById('ontime_'+id);
				var submitInformations = document.getElementById('signInformations').value;
				var re =new RegExp("/"+id + "_1","g");
				var re_1 =new RegExp("/"+id + "_0","g");
				
				if(onTimeState.checked == true){
					if(re.test(submitInformations)){
						submitInformations_1 = submitInformations.replace(re,"");
						document.getElementById('signInformations').value = submitInformations_1;
					}
				}
				if(re_1.test(submitInformations) && onTimeState.checked == false){
					submitInformations_1 = submitInformations.replace(re_1,"");
					document.getElementById('signInformations').value = submitInformations_1;
				}else{
					document.getElementById('signInformations').value += '/'+id+'_0';
				}
				onTimeState.checked = false;
			}
		}
		//工牌
		function iscard(userid){
			var card = document.getElementById(userid);
			var id = userid.substr(1);
			var cards = document.getElementById('signCard_1');
			var submitCard = cards.value;
			var re =new RegExp("/"+id + "_1","g");
			var re_1 =new RegExp("/"+id + "_0","g");
			var val = "/"+id + "_1";
			var val_1 = "/"+id + "_0";
			if(card.checked == false){
				submitCard_1 = submitCard.replace(re,"");
				cards.value = submitCard_1;
				cards.value += val_1;
			}else if(card.checked == true){
				submitCard_1 = submitCard.replace(re_1,"");
				cards.value = submitCard_1;
				cards.value += val;
			}
		}
		//缺席
		function attend(userid){
			var att = document.getElementById(userid);
			var id = userid.substr(1);
			var attends = document.getElementById('signAttend_1');
			var submitattend = attends.value;
			var re =new RegExp("/"+id + "_1","g");
			var re_1 =new RegExp("/"+id + "_0","g");
			var val = "/"+id + "_1";
			var val_1 = "/"+id + "_0";
			if(att.checked == false){
				submitattend_1 = submitattend.replace(re,"");
				attends.value = submitattend_1;
				attends.value += val_1;
			}else if(att.checked == true){
				submitattend_1 = submitattend.replace(re_1,"");
				attends.value = submitattend_1;
				attends.value += val;
			}else{
				attends.value += val;
			}
		}
		//倒计时
		function times(){
			var date = new Date();
			var nowtime = date.getTime();//当前时间
			var meetTime = {-$start-};
			var timeDifference = (meetTime - nowtime)/1000;
			if(timeDifference > 0){
				if(timeDifference > 86400){
					var day = Math.floor((timeDifference/86400));//天
					var surplusTime = timeDifference - (day*86400);
				}
				if(timeDifference < 86400){
					var day = 0;//天
					var surplusTime = timeDifference;
				}
				if(surplusTime > 3600){
					var hours = Math.floor((surplusTime/3600));//时
					var surplusTime1 = surplusTime - (hours*3600);
				}
				if(surplusTime < 3600){
					var hours = 0;//小时
					var surplusTime1 = surplusTime;
				}
				if(surplusTime1 > 60){
					var minute =  Math.floor((surplusTime1/60));//分
					var second =  Math.floor(surplusTime1 - (minute*60));//秒
				}
				if(surplusTime1 < 60){ 
					var minute = 0;//分
					var second = Math.floor(surplusTime1);//秒
				}
				var timeD = day+"天"+hours+"时"+minute+"分"+second+"秒";
				if(day == 0 && hours == 0 && minute == 4 && second == 59){
					alert('离会议开始还有5分钟，请确认签到信息，并在会议开始前提交准时到会人员信息！过期不候哦！');
				}
				document.getElementById('timeDifference_1').innerHTML = timeD;
				setTimeout("times()",1000);
			}else{//当会议开始后执行
				document.getElementById('timeDifference_1').innerHTML = 0+"天"+0+"时"+0+"分"+0+"秒";
				document.getElementById('allontime').disabled = true;
				var all = document.getElementsByTagName("input");
				for(var i=0;i<all.length;i++){
					var long = all[i];
					if(long.name == 'ontimeState'){
						long.disabled = true;//锁定签到准时框
						long.style.display = 'none';
					}
				}
				if(timeDifference < -43200){//关闭签到功能
					var all = document.getElementsByTagName("input");
					for(var i=0;i<all.length;i++){
						var long = all[i];
						if(long.name != 'subMeetRecordButton'){
							long.disabled = true;
							long.style.display = 'inline';
						}
					}
				}
			}
		}
		window.onload=times;
		//全选
		function allSelected(){
			var keywords = document.getElementById('allontime').value;
			var allinput = document.getElementsByTagName("input");
			if(keywords == '全选准时'){
				document.getElementById('allontime').value = '取消全选';
				for(var i=0;i<allinput.length;i++){
					var long = allinput[i];
					if(long.name == 'ontimeState'){
						var classid = long.id;
						var id = classid.substr(7);
						var state = 'ontime';
						signIn(classid,id,state);
						long.checked = true;//全选准时
					}
				}
			}
			if(keywords == '取消全选'){
				document.getElementById('allontime').value = '全选准时';
				for(var i=0;i<allinput.length;i++){
					var long = allinput[i];
					if(long.name == 'ontimeState'){
						document.getElementById('signInformations').value = '';
						long.checked = false;//取消全选准时
					}
				}
			}
		}
		
	</script>
	<script type="text/javascript">
		//提交签到信息
		$(function($){
			$('#submitInformation').click(function(){
				$a = confirm('确认提交?');
				if($a == true){
					var signInformations_1 = $('#signInformations').val();
					var signCard = $('#signCard_1').val();
					var signAttend = $('#signAttend_1').val();
					$.ajax({
						   type: "POST",
						   url: "{-$smarty.const.ROOT_URL-}index.php?module=meeting&action=conference&id={-$bookid-}",
						   data: "meet=signInformation="+signInformations_1+"//signcards="+signCard+"//signAttends="+signAttend,
						   success: function(data){
						    	if(data = 1){
						    		window.location.reload();
						    	}
						   }
						});
				}
			});
			
		});
		//提交会议记录
		function sub(){
			if(confirm('是否提交？')){
				document.getElementById('meetCkeditor').submit();
			}
		}
	
	</script>
{-include file="footer.htm"-}